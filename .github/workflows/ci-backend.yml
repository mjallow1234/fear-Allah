name: CI Backend

on:
  push:
    branches: [main]
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - uses: actions/setup-python@v4
      with:
        python-version: 3.11

    - name: Install dependencies
      run: |
        pip install -r backend/requirements.txt
        pip install pytest
        pip install -U pytest-anyio
        pip list | grep anyio || true

    - name: Run unit tests
      working-directory: backend
      env:
        PYTHONPATH: ${{ github.workspace }}/backend
      run: |
        bash -lc 'pytest -q -k "not e2e" -m "not integration" --timeout=300; RC=$?; if [ "$RC" -eq 5 ]; then echo "No tests collected (pytest exit code 5). Treating as success in CI."; exit 0; else exit $RC; fi'
